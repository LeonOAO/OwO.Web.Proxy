<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">OwOb</title>

  <!-- Option B: icons live in repo root, this page is /ixlmath/ so use ../ -->
  <link id="favicon" rel="icon" href="../favicon.png" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-E9DZ1KWKQT');
  </script>

  <!-- Core scripts (this file is /ixlmath/index.html so these are correct) -->
  <script src="./baremux/index.js"></script>
  <script src="./scram/scramjet.all.js"></script>
  
<style>
  /* =========================
     Minimal Glass UI (Arc-like)
     ========================= */

  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; }

  :root{
    --bg-0: #07080a;
    --bg-1: #0a0b0f;

    /* glass */
    --glass: rgba(20, 22, 26, 0.55);
    --glass-strong: rgba(20, 22, 26, 0.78);
    --glass-border: rgba(255, 255, 255, 0.10);
    --glass-border-2: rgba(255, 255, 255, 0.14);

    /* text */
    --text: rgba(248, 250, 252, 0.92);
    --muted: rgba(148, 163, 184, 0.78);
    --muted-2: rgba(148, 163, 184, 0.55);

    /* accents (very subtle) */
    --accent: rgba(139, 92, 246, 0.85);
    --accent-soft: rgba(139, 92, 246, 0.18);

    /* shadows */
    --shadow: 0 18px 45px rgba(0,0,0,0.55);
    --shadow-soft: 0 10px 28px rgba(0,0,0,0.35);

    /* radius */
    --r-sm: 10px;
    --r-md: 14px;
    --r-lg: 18px;

    /* layout */
    --tab-h: 40px;
    --nav-h: 56px;
    --top-h: 108px;
  }

  body{
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
    overflow: hidden;

    /* Minimal background with very soft highlights */
    background:
      radial-gradient(900px 520px at 18% 12%, rgba(255,255,255,0.06), transparent 55%),
      radial-gradient(820px 520px at 82% 22%, rgba(139,92,246,0.08), transparent 58%),
      radial-gradient(920px 620px at 50% 110%, rgba(255,255,255,0.05), transparent 62%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* subtle noise (very light) */
  body::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.08;
    background:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.45'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
  }

  ::selection { background: rgba(139, 92, 246, 0.25); }

  @media (prefers-reduced-motion: reduce){
    *{ animation: none !important; transition: none !important; }
  }

  /* ===== Loading ===== */
  #loading-screen{
    position: fixed;
    inset: 0;
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    background:
      radial-gradient(900px 600px at 50% 40%, rgba(255,255,255,0.06), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
    transition: opacity 0.45s ease;
  }
  .black-hole{
    height: 92px;
    aspect-ratio: 1;
    border-radius: 50%;
    background:
      radial-gradient(circle at 35% 30%, rgba(255,255,255,0.16), transparent 38%),
      radial-gradient(circle at 50% 55%, rgba(0,0,0,0.75), rgba(0,0,0,1) 65%),
      #000;
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.10),
      0 20px 45px rgba(0,0,0,0.55);
    animation: breathe 2.4s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{ transform: scale(1); }
    50%{ transform: scale(1.045); }
  }

  /* ===== Top UI hide ===== */
  #top-ui{
    transition: transform 0.38s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }
  body.nav-hidden #top-ui{ transform: translateY(-108px); }
  body.nav-hidden .frame-container{ top: 0 !important; }

  /* ===== Tab Strip ===== */
  .tab-strip{
    height: var(--tab-h);
    padding: 10px 12px 0 12px;
    display: flex;
    align-items: flex-end;
    gap: 8px;

    /* glass bar */
    background: transparent;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tab-strip::-webkit-scrollbar{ width:0; height:0; }

  .tab{
    min-width: 150px;
    max-width: 220px;
    height: 30px;
    padding: 7px 10px;
    border-radius: 12px 12px 0 0;

    display: flex;
    align-items: center;
    gap: 8px;

    color: rgba(248,250,252,0.68);
    background: rgba(255,255,255,0.02);
    border: 1px solid transparent;
    border-bottom: none;

    cursor: pointer;
    user-select: none;
    transition: background 0.16s ease, border-color 0.16s ease, color 0.16s ease, transform 0.16s ease;
  }
  .tab:hover{
    background: rgba(255,255,255,0.05);
    transform: translateY(-1px);
    color: rgba(248,250,252,0.82);
  }
  .tab.active{
    color: rgba(248,250,252,0.93);
    background: var(--glass);
    border-color: var(--glass-border);
    backdrop-filter: blur(14px);
    box-shadow: 0 -10px 26px rgba(0,0,0,0.25);
    position: relative;
  }
  .tab.active::after{
    content:"";
    position: absolute;
    left: 12px;
    right: 12px;
    bottom: -1px;
    height: 2px;
    border-radius: 999px;
    background: rgba(255,255,255,0.18);
  }

  .close-tab-btn{
    margin-left: 6px;
    background: transparent;
    border: none;
    color: inherit;
    font-size: 16px;
    line-height: 1;
    padding: 2px 6px;
    border-radius: 10px;
    opacity: 0.55;
    cursor: pointer;
    transition: background 0.15s ease, opacity 0.15s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .close-tab-btn:hover{
    opacity: 1;
    background: rgba(255,255,255,0.08);
  }

  /* ===== Navbar (Glass) ===== */
  .navbar{
    height: var(--nav-h);
    padding: 0 14px;
    display: flex;
    align-items: center;
    gap: 12px;

    background: var(--glass-strong);
    border-bottom: 1px solid var(--glass-border);
    backdrop-filter: blur(16px);
    box-shadow: var(--shadow-soft);
  }

  .nav-buttons{
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-button{
    width: 36px;
    height: 36px;
    border-radius: 12px;

    display: inline-flex;
    align-items: center;
    justify-content: center;

    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    color: rgba(248,250,252,0.72);

    cursor: pointer;
    user-select: none;

    transition: background 0.14s ease, border-color 0.14s ease, transform 0.14s ease, color 0.14s ease;
  }
  .nav-button:hover{
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.14);
    transform: translateY(-1px);
    color: rgba(248,250,252,0.9);
  }
  .nav-button:active{
    transform: translateY(0) scale(0.98);
  }

  .settings-icon-img{
    width: 20px;
    height: 20px;
    object-fit: contain;
    opacity: 0.85;
    transition: opacity 0.14s ease;
  }
  .nav-button:hover .settings-icon-img{ opacity: 1; }

  /* ===== Address bar ===== */
  .search-container{
    flex: 1;
    min-width: 160px;
    height: 40px;
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 10px;

    background: rgba(10, 12, 16, 0.42);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 14px;

    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.18);
    transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
  }
  .search-container:focus-within{
    border-color: rgba(255,255,255,0.18);
    background: rgba(10,12,16,0.55);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,0.24),
      0 0 0 3px rgba(139,92,246,0.10);
  }

  input#bar{
    flex: 1;
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    color: rgba(248,250,252,0.92);
    font-size: 14px;
    padding: 10px 4px;
  }
  input#bar::placeholder{ color: rgba(148,163,184,0.70); }

  /* ===== Frame area ===== */
  .frame-container{
    position: absolute;
    top: calc(var(--tab-h) + var(--nav-h) + 12px);
    left: 0;
    right: 0;
    bottom: 0;
    background: #000;
    transition: top 0.38s cubic-bezier(0.4, 0, 0.2, 1);
  }
  iframe{
    width: 100%;
    height: 100%;
    border: none;
    display: none;
    background: #000;
  }
  iframe.active{ display: block; }

  /* ===== New Tab (Minimal Glass Card) ===== */
  .new-tab-screen{
    position: absolute;
    inset: 0;
    z-index: 5;
    display: flex;
    align-items: center;
    justify-content: center;

    background:
      radial-gradient(900px 520px at 50% 30%, rgba(255,255,255,0.05), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
  }
  .new-tab-content{
    text-align: center;
    padding: 28px 26px;
    border-radius: var(--r-lg);
    background: var(--glass);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
    backdrop-filter: blur(18px);
    width: min(520px, calc(100vw - 46px));
  }
  .new-tab-content h1{
    margin: 0;
    font-size: clamp(38px, 6vw, 56px);
    letter-spacing: -0.02em;
    font-weight: 750;

    /* minimal: almost white, subtle tint */
    background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(233, 227, 255, 0.78));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .new-tab-content p{
    margin: 12px 0 0 0;
    color: var(--muted);
    letter-spacing: 2.6px;
    font-size: 12px;
    text-transform: uppercase;
  }

  /* ===== Modal (Glass) ===== */
  .modal-overlay{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100000;
    background: rgba(0,0,0,0.62);
    backdrop-filter: blur(10px);
  }
  .modal-overlay.show{ display: flex; }

  .modal-content{
    width: min(480px, calc(100vw - 24px));
    max-height: min(86vh, 760px);
    overflow: auto;

    border-radius: 18px;
    padding: 22px 20px;
    background: var(--glass-strong);
    border: 1px solid var(--glass-border-2);
    box-shadow: 0 26px 75px rgba(0,0,0,0.62);
    backdrop-filter: blur(18px);
  }

  /* nicer scroll */
  .modal-content::-webkit-scrollbar{ width: 10px; }
  .modal-content::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,0.10);
    border-radius: 999px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }
  .modal-content::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.16); }

  .section-label{
    display: block;
    margin: 16px 0 8px 0;
    color: var(--muted-2);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .setting-btn{
    width: 100%;
    padding: 12px 12px;
    margin: 6px 0;
    border-radius: 14px;

    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.10);
    color: rgba(248,250,252,0.9);

    cursor: pointer;
    transition: transform 0.14s ease, background 0.14s ease, border-color 0.14s ease, color 0.14s ease;
    font-weight: 600;
    letter-spacing: 0.9px;
    text-transform: uppercase;
    font-size: 10.5px;

    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .setting-btn:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.14);
  }
  .setting-btn:active{ transform: translateY(0) scale(0.99); }

  .setting-btn.primary{
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.16);
    color: rgba(248,250,252,0.95);
  }
  .setting-btn.primary:hover{
    border-color: rgba(255,255,255,0.22);
    box-shadow: 0 0 0 3px rgba(139,92,246,0.08);
  }

  .setting-btn.active-wisp{
    background: rgba(139,92,246,0.10);
    border-color: rgba(139,92,246,0.22);
  }

  .ping-tag{
    position: absolute;
    right: 12px;
    font-size: 9px;
    opacity: 0.7;
    letter-spacing: 1px;
  }

  .btn-row{
    display: flex;
    gap: 10px;
  }
  .btn-row .setting-btn{ flex: 1; }

  .custom-wisp-box{
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: center;
  }
  .custom-wisp-input{
    flex: 1;
    height: 38px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(10, 12, 16, 0.42);
    color: rgba(248,250,252,0.92);
    outline: none;
    font-size: 12px;
    transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
  }
  .custom-wisp-input:focus{
    border-color: rgba(255,255,255,0.18);
    background: rgba(10,12,16,0.55);
    box-shadow: 0 0 0 3px rgba(139,92,246,0.10);
  }

  /* ===== Responsive ===== */
  @media (max-width: 560px){
    .navbar{ padding: 0 12px; gap: 10px; }
    .nav-button{ width: 34px; height: 34px; }
    .tab{ min-width: 140px; }
    .new-tab-content{ padding: 24px 18px; }
  }
</style>
  
</head>

<body>
  <div id="loading-screen"><div class="black-hole"></div></div>

  <div id="top-ui">
    <div class="tab-strip" id="tab-strip">
      <div class="nav-button" onclick="createNewTab()" style="font-size: 24px;">+</div>
    </div>

    <nav class="navbar">
      <div class="nav-buttons">
        <div class="nav-button" onclick="goBack()">←</div>
        <div class="nav-button" onclick="goForward()">→</div>
        <div class="nav-button" onclick="reloadPage()">↻</div>
      </div>

      <div class="search-container">
        <input type="text" placeholder="Search with Brave or enter URL" id="bar" autocomplete="off" />
      </div>

      <div class="nav-buttons">
        <div class="nav-button" onclick="showSettings()">
          <img src="../settingsicon.png" class="settings-icon-img" alt="Settings" />
        </div>
        <div class="nav-button" onclick="toggleFullScreen()">⛶</div>
      </div>
    </nav>
  </div>

  <div class="frame-container" id="frame-container">
    <div id="new-tab-ui" class="new-tab-screen">
      <div class="new-tab-content" style="text-align: center;">
        <h1>Zyron</h1>
        <p style="color: var(--text-muted); letter-spacing: 2px; font-size: 12px;">MADE BY ARCTIC 1.0</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal" onclick="hideSettings()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h2 style="margin-top:0; color: var(--accent); letter-spacing: 2px; font-size: 18px; text-transform: uppercase;">Settings</h2>

      <span class="section-label">General</span>
      <button class="setting-btn primary" onclick="openAboutBlank()">Open in About:Blank</button>
      <button class="setting-btn" onclick="hideNavbar()">Hide Navigation Bar</button>
      <button id="cloak-toggle-btn" class="setting-btn" onclick="toggleCloaking()">Enable Tab Cloaking (Drive)</button>

      <span class="section-label">Wisp Servers</span>
      <div style="display: flex; flex-direction: column; gap: 0;">
        <button id="wisp-main" class="setting-btn active-wisp" onclick="setWisp('main')">
          Main Server <span class="ping-tag" id="ping-main">--ms</span>
        </button>
        <div class="btn-row">
          <button id="wisp-backup2" class="setting-btn" onclick="setWisp('backup2')">
            Backup 2 <span class="ping-tag" id="ping-backup2">--ms</span>
          </button>
          <button id="wisp-backup3" class="setting-btn" onclick="setWisp('backup3')">
            Backup 3 <span class="ping-tag" id="ping-backup3">--ms</span>
          </button>
        </div>
        <div class="btn-row">
          <button id="wisp-backup4" class="setting-btn" onclick="setWisp('backup4')">
            Backup 4 <span class="ping-tag" id="ping-backup4">--ms</span>
          </button>
          <button id="wisp-backup5" class="setting-btn" onclick="setWisp('backup5')">
            Backup 5 <span class="ping-tag" id="ping-backup5">--ms</span>
          </button>
        </div>
        <div class="btn-row">
          <button id="wisp-backup6" class="setting-btn" onclick="setWisp('backup6')">
            Backup 6 <span class="ping-tag" id="ping-backup6">--ms</span>
          </button>
          <button id="wisp-backup7" class="setting-btn" onclick="setWisp('backup7')">
            Backup 7 <span class="ping-tag" id="ping-backup7">--ms</span>
          </button>
        </div>
        <div class="btn-row">
          <button id="wisp-backup8" class="setting-btn" onclick="setWisp('backup8')">
            Backup 8 <span class="ping-tag" id="ping-backup8">--ms</span>
          </button>
          <button id="wisp-backup9" class="setting-btn" onclick="setWisp('backup9')">
            Backup 9 <span class="ping-tag" id="ping-backup9">--ms</span>
          </button>
        </div>
        <div class="btn-row">
          <button id="wisp-backup10" class="setting-btn" onclick="setWisp('backup10')">
            Backup 10 <span class="ping-tag" id="ping-backup10">--ms</span>
          </button>
        </div>

        <div class="custom-wisp-box">
          <input type="text" id="custom-wisp-url" class="custom-wisp-input" placeholder="wss://your-wisp-server/wisp/" />
          <button class="setting-btn" style="margin:0; width: auto; padding: 0 15px;" onclick="setCustomWisp()">Use</button>
        </div>
      </div>

      <button class="setting-btn" onclick="hideSettings()" style="margin-top: 20px; border: none; background: transparent; opacity: 0.6; text-transform: none; letter-spacing: 0;">
        Close
      </button>
    </div>
  </div>

  <script>
    // Base URL is /OwO.Web.Proxy/ixlmath/ because this file is in /ixlmath/
    const BASE_URL = new URL('./', window.location.href);

    function assetUrl(path) {
      const cleaned = String(path).replace(/^\/+/, '');
      return new URL(cleaned, BASE_URL).toString();
    }

    function assetPathname(path) {
      const cleaned = String(path).replace(/^\/+/, '');
      return new URL(cleaned, BASE_URL).pathname;
    }

    // ===== Service Worker registration (correct for /ixlmath/) =====
    // Must keep scope under the SW directory. [4](https://developers.google.com/tag-platform/gtagjs)[5](https://docs.github.com/pages)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(assetUrl('sw.js'), { scope: assetPathname('./') })
          .catch(err => console.error('SW register failed:', err));
      });
    }

    // ===== Tab Cloaking Logic =====
    function updateCloakUI() {
      const isCloaked = localStorage.getItem('zyron-cloaked') === 'true';
      const btn = document.getElementById('cloak-toggle-btn');

      if (isCloaked) {
        document.title = 'My Drive - Google Drive';
        document.getElementById('favicon').href = 'https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png';
        btn.innerText = 'Disable Tab Cloaking';
        btn.classList.add('active-wisp');
      } else {
        document.title = 'Zyron';
        document.getElementById('favicon').href = '../favicon.png';
        btn.innerText = 'Enable Tab Cloaking (Drive)';
        btn.classList.remove('active-wisp');
      }
    }

    function toggleCloaking() {
      const isCloaked = localStorage.getItem('zyron-cloaked') === 'true';
      localStorage.setItem('zyron-cloaked', !isCloaked);
      updateCloakUI();
    }

    const _d = (s) => atob(s);

    const wispUrls = {
      main: _d("d3NzOi8vZHl3aG1jd3AxeTk2bS5jbG91ZGZyb250Lm5ldC93aXNwLw=="),
      backup2: _d("d3NzOi8vd2lzcC5yaHcub25lLw=="),
      backup3: _d("d3NzOi8vaXhsbWF0aGxvZ2luLml4bC5iZXN0L3dpc3Av"),
      backup4: _d("d3NzOi8vczBsYWNlLWoybnAub25yZW5kZXIuY29tL3dpc3Av"),
      backup5: _d("d3NzOi8venlyb25nYXJkZW5pbmdhbG9yZS5zcGVlZGluc3VyZS5oay93aXNwLw=="),
      backup6: _d("d3NzOi8vZ2xzZXJpZXMubmV0L3dpc3Av"),
      backup7: _d("d3NzOi8vZ29pbnRvc3BhY2UuYXBwL3dpc3Av"),
      backup8: _d("d3NzOi8vZGFzaC5nb2lwLmRlL3dpc3Av"),
      backup9: _d("d3NzOi8vZGFzaC5nb2lwLmRlL3dpc3Av"),
      backup10: _d("d3NzOi8vd2lzcC50ZXJiaXVtb24udG9wL3dpc3Av")
    };

    let tabs = [];
    let activeTabId = null;
    let currentWisp = wispUrls.main;

    // ===== BareMux + Scramjet paths (correct for /ixlmath/) =====
    const connection = new BareMux.BareMuxConnection(assetUrl('baremux/worker.js'));

    function initProxy() {
      connection.setTransport(assetUrl('libcurl/index.mjs'), [{ websocket: currentWisp }]);
    }

    // ✅ IMPORTANT: prefix must be a pathname (NOT full URL) and must match SW routing. 
    const PREFIX_PATH = new URL('./go/', window.location.href).pathname; // "/OwO.Web.Proxy/ixlmath/go/"

    const { ScramjetController } = $scramjetLoadController();
    const scramjet = new ScramjetController({
      files: {
        all: assetUrl('scram/scramjet.all.js'),
        wasm: assetUrl('scram/scramjet.wasm.wasm'),
        sync: assetUrl('scram/scramjet.sync.js')
      },
      prefix: PREFIX_PATH
    });

    function loadWispSettings() {
      const savedWispKey = localStorage.getItem('zyron-wisp-key');
      const savedCustomWisp = localStorage.getItem('zyron-custom-wisp');

      if (savedCustomWisp) {
        currentWisp = savedCustomWisp;
        document.getElementById('custom-wisp-url').value = savedCustomWisp;
        document.querySelectorAll('.active-wisp').forEach(btn => btn.classList.remove('active-wisp'));
      } else if (savedWispKey && wispUrls[savedWispKey]) {
        currentWisp = wispUrls[savedWispKey];
        document.querySelectorAll('.active-wisp').forEach(btn => btn.classList.remove('active-wisp'));
        const btn = document.getElementById(`wisp-${savedWispKey}`);
        if (btn) btn.classList.add('active-wisp');
      }
    }

    function setWisp(type) {
      currentWisp = wispUrls[type];
      localStorage.setItem('zyron-wisp-key', type);
      localStorage.removeItem('zyron-custom-wisp');
      document.querySelectorAll('.active-wisp').forEach(btn => btn.classList.remove('active-wisp'));
      if (document.getElementById(`wisp-${type}`)) document.getElementById(`wisp-${type}`).classList.add('active-wisp');
      initProxy();
    }

    function setCustomWisp() {
      const url = document.getElementById('custom-wisp-url').value.trim();
      if (!url.startsWith('ws')) {
        alert('failed to connect to custom wisp server url');
        return;
      }

      const testSocket = new WebSocket(url);
      const timeout = setTimeout(() => {
        testSocket.close();
        alert('failed to connect to custom wisp server url');
      }, 5000);

      testSocket.onopen = () => {
        clearTimeout(timeout);
        currentWisp = url;
        localStorage.setItem('zyron-custom-wisp', url);
        localStorage.removeItem('zyron-wisp-key');
        document.querySelectorAll('.active-wisp').forEach(btn => btn.classList.remove('active-wisp'));
        initProxy();
        testSocket.close();
        alert('successfully connected to custom wisp server');
      };

      testSocket.onerror = () => {
        clearTimeout(timeout);
        alert('failed to connect to custom wisp server url');
      };
    }

    async function checkWispPing(url, elementId) {
      const start = Date.now();
      try {
        const socket = new WebSocket(url);
        const timeout = setTimeout(() => { socket.close(); }, 3000);

        socket.onopen = () => {
          clearTimeout(timeout);
          const ping = Date.now() - start;
          const el = document.getElementById(elementId);
          if (el) el.innerText = ping + "ms";
          socket.close();
        };
        socket.onerror = () => {
          const el = document.getElementById(elementId);
          if (el) el.innerText = "ERR";
          if (url === currentWisp) autoSwitch();
        };
      } catch (e) {
        const el = document.getElementById(elementId);
        if (el) el.innerText = "ERR";
      }
    }

    function refreshAllPings() {
      Object.keys(wispUrls).forEach(key => {
        checkWispPing(wispUrls[key], `ping-${key}`);
      });
    }

    function autoSwitch() {
      for (const [key, url] of Object.entries(wispUrls)) {
        const el = document.getElementById(`ping-${key}`);
        const pingText = el ? el.innerText : "ERR";

        if (pingText !== "ERR" && pingText !== "--ms") {
          setWisp(key);
          const bar = document.getElementById('bar');
          bar.placeholder = `AUTO-RECOVERY: Switched to ${key}`;
          setTimeout(() => { bar.placeholder = "Search with Brave or enter URL"; }, 4000);
          return;
        }
      }
    }

    setInterval(() => {
      checkWispPing(currentWisp, `ping-${localStorage.getItem('zyron-wisp-key') || 'main'}`);
    }, 10000);

    function showBH() {
      document.getElementById('loading-screen').style.display = 'flex';
      document.getElementById('loading-screen').style.opacity = '1';
    }
    function hideBH() {
      document.getElementById('loading-screen').style.opacity = '0';
      setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
    }

    function createNewTab() {
      const id = Date.now() + Math.random();
      tabs.push({ id, url: '', title: 'New Tab', loading: false });
      const frame = document.createElement('iframe');
      frame.id = `frame-${id}`;
      frame.onload = () => {
        const t = tabs.find(x => x.id === id);
        if (t) { t.loading = false; renderTabs(); hideBH(); }
      };
      document.getElementById('frame-container').appendChild(frame);
      switchTab(id);
    }

    function switchTab(id) {
      activeTabId = id;
      document.querySelectorAll('iframe').forEach(f => f.classList.remove('active'));
      const frame = document.getElementById(`frame-${id}`);
      if (frame) frame.classList.add('active');
      const tab = tabs.find(t => t.id === activeTabId);
      document.getElementById('bar').value = tab.url || '';
      document.getElementById('new-tab-ui').style.display = frame && frame.src ? 'none' : 'flex';
      renderTabs();
    }

    function renderTabs() {
      const strip = document.getElementById('tab-strip');
      const addBtn = strip.querySelector('.nav-button');
      strip.querySelectorAll('.tab').forEach(t => t.remove());
      tabs.forEach(tab => {
        const tabEl = document.createElement('div');
        tabEl.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
        tabEl.onclick = () => switchTab(tab.id);
        tabEl.innerHTML =
          `<span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${tab.title}</span>` +
          `<button class="close-tab-btn" onclick="closeTab(event, ${tab.id})">×</button>`;
        strip.insertBefore(tabEl, addBtn);
      });
    }

    function nav() {
      const val = document.getElementById('bar').value.trim();
      if (!val) return;

      document.activeElement.blur();
      showBH();

      const url = (val.includes('.') && !val.includes(' '))
        ? (val.startsWith('http') ? val : 'https://' + val)
        : `https://search.brave.com/search?q=${encodeURIComponent(val)}`;

      const tab = tabs.find(t => t.id === activeTabId);
      tab.url = url;
      tab.title = url.split('/')[2] || url;

      // encodeUrl uses prefix + encoded href 
      let encoded = scramjet.encodeUrl(url);

      // Ensure iframe gets an absolute URL when encodeUrl returns a pathname
      if (typeof encoded === 'string' && encoded.startsWith('/')) {
        encoded = new URL(encoded, window.location.origin).toString();
      }

      document.getElementById(`frame-${activeTabId}`).src = encoded;
      document.getElementById('new-tab-ui').style.display = 'none';
      renderTabs();
    }

    function reloadPage() {
      const frame = document.getElementById(`frame-${activeTabId}`);
      if (!frame || !frame.src) return;
      showBH();
      try { frame.contentWindow.location.reload(); }
      catch (e) { frame.src = frame.src; }
    }

    // Keep address bar in sync
    setInterval(() => {
      if (!activeTabId) return;
      const frame = document.getElementById(`frame-${activeTabId}`);
      if (!frame || !frame.src) return;

      try {
        const path = frame.contentWindow.location.pathname;

        // PREFIX_PATH is pathname; match based on it 
        if (path.includes(PREFIX_PATH)) {
          const encodedPart = path.split(PREFIX_PATH)[1];
          const decoded = scramjet.decodeUrl(window.location.origin + PREFIX_PATH + encodedPart);

          const tab = tabs.find(t => t.id === activeTabId);
          if (tab && tab.url !== decoded && document.activeElement !== document.getElementById('bar')) {
            tab.url = decoded;
            document.getElementById('bar').value = decoded;
          }
        }
      } catch (e) {}
    }, 1000);

    function hideNavbar() { document.body.classList.add('nav-hidden'); hideSettings(); }

    function openAboutBlank() {
      const win = window.open('about:blank', '_blank');
      if (!win) return;

      const doc = win.document;
      const iframe = doc.createElement('iframe');

      if (localStorage.getItem('zyron-cloaked') === 'true') {
        doc.title = 'My Drive - Google Drive';
      } else {
        doc.title = 'Zyron';
      }

      iframe.style = 'position:fixed;top:0;left:0;width:100%;height:100%;border:none;';
      iframe.src = window.location.href;
      doc.body.appendChild(iframe);

      window.location.replace('https://google.com');
    }

    function closeTab(e, id) {
      e.stopPropagation();
      if (tabs.length === 1) return;
      tabs = tabs.filter(t => t.id !== id);
      const el = document.getElementById(`frame-${id}`);
      if (el) el.remove();
      if (activeTabId === id) switchTab(tabs[0].id);
      else renderTabs();
    }

    function showSettings() { document.getElementById('settings-modal').classList.add('show'); refreshAllPings(); }
    function hideSettings() { document.getElementById('settings-modal').classList.remove('show'); }
    function goBack() { try { document.getElementById(`frame-${activeTabId}`).contentWindow.history.back(); } catch(e){} }
    function goForward() { try { document.getElementById(`frame-${activeTabId}`).contentWindow.history.forward(); } catch(e){} }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

    window.onload = async () => {
      updateCloakUI();
      loadWispSettings();
      initProxy();

      if ('serviceWorker' in navigator) {
        try {
          await navigator.serviceWorker.ready;
        } catch (e) {}
      }

      await scramjet.init();
      await scramjet.modifyConfig({ prefix: PREFIX_PATH });

      createNewTab();
      refreshAllPings();
      setTimeout(hideBH, 1000);
    };

    document.getElementById('bar').onkeydown = (e) => { if (e.key === 'Enter') nav(); };
  </script>
</body>
</html>
