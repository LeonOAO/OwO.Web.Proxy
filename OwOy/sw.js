if(navigator.userAgent.includes('Firefox')){Object.defineProperty(globalThis,'crossOriginIsolated',{value:true,writable:false,});}const SW_SCOPE=(self.registration&&self.registration.scope)?self.registration.scope:new URL('./',self.location.href).toString();const GO_PREFIX=new URL('./go/',SW_SCOPE).pathname;importScripts(new URL('scram/scramjet.all.js',SW_SCOPE).toString());const{ScramjetServiceWorker}=$scramjetLoadWorker();const scramjet=new ScramjetServiceWorker();const CONFIG={blocked:[]};let playgroundData;function escapeRegex(s){return String(s).replace(/[\^$.*+?()[\]{}|]/g,'\$&');}function toRegex(pattern){const escaped=escapeRegex(pattern).replace(/\*\*/g,'{{DOUBLE_STAR}}').replace(/\*/g,'[^/]*').replace(/{{DOUBLE_STAR}}/g,'.*');return new RegExp(`^${escaped}$`);}function isBlocked(hostname,pathname){return(CONFIG.blocked||[]).some((pattern)=>{if(pattern.startsWith('#'))pattern=pattern.substring(1);if(pattern.startsWith('*'))pattern=pattern.substring(1);if(pattern.includes('/')){const[hostPattern,...pathParts]=pattern.split('/');const pathPattern=pathParts.join('/');const hostRegex=toRegex(hostPattern);const pathRegex=toRegex(`/${pathPattern}`);return hostRegex.test(hostname)&&pathRegex.test(pathname);}const hostRegex=toRegex(pattern);return hostRegex.test(hostname);});}async function scramjetFetchSafe(event){await scramjet.loadConfig();const expectedGoPrefix=GO_PREFIX;const currentPrefix=scramjet.config&&scramjet.config.prefix;const reqUrl=new URL(event.request.url);if(currentPrefix&&!String(currentPrefix).endsWith('/go/')&&reqUrl.pathname.startsWith(expectedGoPrefix)){const encodedPart=reqUrl.pathname.slice(expectedGoPrefix.length);const normalizedUrl=new URL(String(currentPrefix).replace(/\/+$/,'/')+encodedPart,self.location.origin).toString();const normalizedReq=new Request(normalizedUrl,event.request);return scramjet.fetch({request:normalizedReq,clientId:event.clientId});}return scramjet.fetch({request:event.request,clientId:event.clientId});}async function handleRequest(event){const reqUrl=new URL(event.request.url);const isGo=reqUrl.pathname.startsWith(GO_PREFIX);if(isGo)void 0;if(reqUrl.href.includes('supabase.co')){return fetch(event.request);}await scramjet.loadConfig();const shouldRoute=scramjet.route(event);if(isGo){void 0;void 0;}if(shouldRoute){try{const response=await scramjetFetchSafe(event);const contentType=response.headers.get('content-type')||'';if(contentType.includes('text/html')){const originalText=await response.text();const encoder=new TextEncoder();const byteLength=encoder.encode(originalText).length;const newHeaders=new Headers(response.headers);newHeaders.set('content-length',byteLength.toString());return new Response(originalText,{status:response.status,statusText:response.statusText,headers:newHeaders,});}return response;}catch(err){return new Response(JSON.stringify({message:String(err&&err.message?err.message:err),url:reqUrl.href,configPrefix:scramjet.config&&scramjet.config.prefix,expectedGoPrefix:new URL('./go/',SW_SCOPE).pathname,},null,2),{status:500,headers:{'content-type':'application/json'}});}}return fetch(event.request);}self.addEventListener('fetch',(event)=>{event.respondWith(handleRequest(event));});self.addEventListener('message',({data})=>{if(data&&data.type==='playgroundData'){playgroundData=data;}});scramjet.addEventListener('request',(e)=>{if(isBlocked(e.url.hostname,e.url.pathname)){e.response=new Response('Site Blocked',{status:403});return;}if(playgroundData&&e.url.href.startsWith(playgroundData.origin)){const routes={'/':{content:playgroundData.html,type:'text/html'},'/style.css':{content:playgroundData.css,type:'text/css'},'/script.js':{content:playgroundData.js,type:'application/javascript'},};const route=routes[e.url.pathname];if(route){const headers={'content-type':route.type};e.response=new Response(route.content,{headers});e.response.rawHeaders=headers;e.response.rawResponse={body:e.response.body,headers,status:e.response.status,statusText:e.response.statusText,};e.response.finalURL=e.url.toString();}else{e.response=new Response('empty response',{headers:{}});}}});